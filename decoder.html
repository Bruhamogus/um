from flask import Flask, request, jsonify
import numpy as np
import scipy.io.wavfile as wav
from pydub import AudioSegment
import os

app = Flask(__name__)

def decode_wave(mp3_file):
    """Decodes text from an MP3 file based on frequency encoding."""
    temp_wav = "temp_decoded.wav"
    audio = AudioSegment.from_mp3(mp3_file)
    audio.export(temp_wav, format="wav")
    
    sample_rate, data = wav.read(temp_wav)
    os.remove(temp_wav)

    duration = 0.1  # Duration per character
    segment_size = int(sample_rate * duration)
    chars = []
    
    for i in range(0, len(data), segment_size):
        segment = data[i:i+segment_size]
        fft_freq = np.fft.fftfreq(len(segment), 1/sample_rate)
        magnitude = np.abs(np.fft.fft(segment))
        dominant_freq = abs(fft_freq[np.argmax(magnitude)])
        char_code = int(dominant_freq / 10)
        chars.append(chr(char_code))
    
    return "".join(chars)

@app.route('/decode', methods=['POST'])
def decode_audio():
    if 'file' not in request.files:
        return "No file uploaded", 400
    
    file = request.files['file']
    if file.filename == '':
        return "No file selected", 400
    
    decoded_text = decode_wave(file)
    return decoded_text

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
